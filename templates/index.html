<!DOCTYPE html>
<html>
<head>
  <title>QuickChat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
  <h1>Welcome, {{ username }}!</h1>

  <form action="/join" method="POST">
    <input type="text" name="room" placeholder="Enter Room Name" required>
    <button class="join" type="submit">Create Room</button>
  </form>

  <h2>Existing Rooms</h2>
  <ul id="room-list">
    {% for room, room_id, creator_id in rooms %}
      <li id="room-{{ room }}" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <button style="flex: 0 0 70%; text-align: left;" 
                onclick="loadchat('{{ room }}')"
                {% if room_id not in joined_rooms %}disabled {% else %} class="join" {% endif %}>
          {{ room }}
        </button>
        
        {% if room_id not in joined_rooms %}
          <button class="join" style="flex: 0 0 10%; text-align: left;" onclick="joinRoom('{{ room }}')">Join</button>
        {% else %}
          <button class="leave" style="flex: 0 0 10%; text-align: left;" onclick="leaveRoom('{{ room }}')">Leave</button>
        {% endif %}
        
        {% if creator_id == user_id %}
          <button class="delete" style="flex: 0 0 10%; text-align: left;" onclick="deleteRoom('{{ room }}')">Delete</button>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  <div id="chat-box" style="display:none;">
    <h2 id="current-room-name"></h2>
    <div id="messages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
    <input type="text" id="message-input" placeholder="Type a message..." style="width: 80%;">
    <button type="button" class="join" onclick="sendMessage()">Send</button>
  </div>

  <div style="margin-top: 20px;">
    <form action="/logout">
      <button class="leave" type="submit">Logout</button>
    </form>
  </div>

  <form id="hidden-delete-form" action="/delete_room" method="POST" style="display: none;">
    <input type="hidden" name="room" id="hidden-delete-room">
  </form>

  <script>
    const socket = io();
    let currentRoom = '';
    const username = "{{ username }}";

    // Auto-load chat if room parameter exists
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const room = urlParams.get('room');
      if (room) loadchat(room);
    });

    function joinRoom(room) {
      fetch('/join', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ room })
      }).then(() => window.location.href = `/?room=${encodeURIComponent(room)}`);
    }

  //   function leaveRoom(room) {
  //     socket.emit('leave_room', { room: currentRoom, username });
  //     fetch('/leave', {
  //       method: 'POST',
  //       headers: {'Content-Type': 'application/x-www-form-urlencoded'},
  //       body: new URLSearchParams({ room })
  //     }).then(() => {
  //   // Clear room from URL and reload
  //   window.history.replaceState({}, '', window.location.pathname);
  //   window.location.reload();
  // });
  //   }

  function leaveRoom(room) {
  socket.emit('leave_room', { room, username }); // <-- use 'room' instead of 'currentRoom'
  fetch('/leave', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: new URLSearchParams({ room })
  }).then(() => {
    if (currentRoom === room) {
      document.getElementById("chat-box").style.display = 'none';
      document.getElementById("current-room-name").innerText = '';
      document.getElementById("messages").innerHTML = '';
      currentRoom = '';
    }
    // Reload room list UI only (optional)
    window.history.replaceState({}, '', window.location.pathname);
    window.location.reload(); // this works, but you can also dynamically update the DOM if preferred
  });
}

    function loadchat(room) {
      if (currentRoom == room) return;
      else if(currentRoom){
        document.getElementById("chat-box").style.display = 'none';
        document.getElementById("current-room-name").innerText = '';
        document.getElementById("messages").innerHTML = '';
      }
      // Join new room
      currentRoom = room;
      socket.emit('join_room', { room, username });
      
      // Update UI
      document.getElementById('chat-box').style.display = 'block';
      document.getElementById('current-room-name').textContent = `Room: ${room}`;
      
      // Load history
      fetch(`/history/${room}`)
        .then(res => res.json())
        .then(data => {
          const messages = document.getElementById('messages');
          messages.innerHTML = data.messages.map(m => `<div>${m.msg}</div>`).join('');
          messages.scrollTop = messages.scrollHeight;
        });
    }

    function sendMessage() {
      const input = document.getElementById('message-input');
      const msg = input.value.trim();
      if (msg) {
        socket.emit('send_message', {
          room: currentRoom,
          msg: msg,
          username: username
        });
        input.value = '';
      }
    }

    function deleteRoom(room) {
      if (confirm(`Delete ${room} permanently?`)) {
        document.getElementById('hidden-delete-room').value = room;
        document.getElementById('hidden-delete-form').submit();
      }
    }

    // Socket listeners
    socket.on('message', data => {
      const messages = document.getElementById('messages');
      messages.innerHTML += `<div>${data.msg}</div>`;
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on('room_created', data => {
      if (document.getElementById(`room-${data.room}`)) return;
      
      const li = document.createElement('li');
      li.id = `room-${data.room}`;
      li.style = "display: flex; align-items: center; gap: 10px; margin-bottom: 10px;";
      
      li.innerHTML = `
        <button style="flex: 1; text-align: left;" disabled>${data.room}</button>
        <button class="join" onclick="joinRoom('${data.room}')">Join</button>
        ${data.creator_id === {{ user_id }} ? 
          `<button class="delete" onclick="deleteRoom('${data.room}')">Delete</button>` : ''}
      `;
      
      document.getElementById('room-list').appendChild(li);
    });

    socket.on('room_deleted', data => {
      const elem = document.getElementById(`room-${data.room}`);
      if (elem) elem.remove();
      if (currentRoom === data.room) {
        document.getElementById('chat-box').style.display = 'none';
        currentRoom = '';
      }
    });
  </script>
</body>
</html>